<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.society.dao.ActivityMapper">
    <resultMap id="ActivityDOMap" type="com.society.model.DO.ActivityDO">
        <id column="activity_id" property="activityId" jdbcType="VARCHAR"/>
        <result column="tag_id" property="tagId" jdbcType="INTEGER"/>
        <result column="create_date" property="createDate" jdbcType="TIMESTAMP"/>
        <result column="creator" property="creator" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="theme" property="theme" jdbcType="VARCHAR"/>
        <result column="planned_num" property="plannedNum" jdbcType="INTEGER"/>
        <result column="invalided" property="invalided" jdbcType="VARCHAR"/>
        <result column="hot" property="hot" jdbcType="INTEGER"/>
        <result column="entry_start_date" property="entryStartDate" jdbcType="TIMESTAMP"/>
        <result column="entry_end_date" property="entryEndDate" jdbcType="TIMESTAMP"/>
        <result column="start_date" property="startDate" jdbcType="TIMESTAMP"/>
        <result column="end_date" property="endDate" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="ActivityBaseVOMap" type="com.society.model.VO.ActivityBaseVO">
        <id column="activity_id" property="activityId" jdbcType="VARCHAR"/>
        <result column="tag_id" property="tagId" jdbcType="INTEGER"/>
        <result column="tag_name" property="tagName" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="theme" property="theme" jdbcType="VARCHAR"/>
        <result column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="head_img_path" property="headImgPath" jdbcType="VARCHAR"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="comment_num" property="tagId" jdbcType="INTEGER"/>
        <result column="agree_num" property="tagId" jdbcType="INTEGER"/>
    </resultMap>

    <resultMap id="ScheduleActivityVOMap" type="com.society.model.VO.ScheduleActivityVO">
        <id column="activity_id" property="activityId" jdbcType="VARCHAR"/>
        <result column="tag_id" property="tagId" jdbcType="INTEGER"/>
        <result column="tag_name" property="tagName" jdbcType="VARCHAR"/>
        <result column="theme" property="theme" jdbcType="VARCHAR"/>
        <result column="creator" property="userId" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="planned_num" property="plannedNum" jdbcType="INTEGER"/>
        <result column="actual_num" property="actualNum" jdbcType="INTEGER"/>
        <result column="start_date" property="startDate" jdbcType="TIMESTAMP"/>
        <result column="end_date" property="endDate" jdbcType="TIMESTAMP"/>
        <result column="invalided" property="invalided" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Activity_List">
      activity_id, tag_id, creat  e_date, creator, content, theme, planned_num,
      hot, entry_start_date, entry_end_date, start_date, end_date
    </sql>

    <sql id="Activity_Base_Info_List">
        activity.activity_id,activity.tag_id,activity.content,theme,activity.creator,
        user_name,tag_name,head_img_path,remark,
        count(comment.commentator) comment_num,
        count(agree.user_id) agree_num
    </sql>

    <select id="getAllActivity" resultMap="ActivityBaseVOMap">
        SELECT
        <include refid="Activity_Base_Info_List"/>
        FROM
        activity
        LEFT JOIN comment on activity.activity_id= comment.activity_id
        LEFT JOIN agree on activity.activity_id= agree.activity_id
        LEFT JOIN user on activity.creator= user.user_id
        LEFT JOIN tags on activity.tag_id= tags.tag_id
        GROUP BY activity.activity_id
        ORDER BY activity.create_date DESC
    </select>

    <select id="get" resultType="java.util.Map" parameterType="java.lang.String">
        SELECT
        activity.activity_id activityId,
        activity.tag_id tagId,
        activity.content,theme,tag_name tagName,
        planned_num plannedNum,hot,
        entry_start_date entryStartDate,
        entry_end_date entryEndDate,
        start_date startDate,
        end_date endDate,
        COUNT(comment.commentator) commentNum,
        COUNT(agree.user_id) agreeNum,
        COUNT(entry_list.user_id) actualNum
        FROM
        activity
        LEFT JOIN comment ON activity.activity_id= comment.activity_id
        LEFT JOIN agree ON activity.activity_id= agree.activity_id
        LEFT JOIN tags ON activity.tag_id= tags.tag_id
        LEFT JOIN entry_list ON activity.activity_id=entry_list.activity_id
        WHERE activity.activity_id=#{activityId,jdbcType=VARCHAR}
        GROUP BY activity.activity_id
    </select>

    <insert id="insert" parameterType="com.society.model.DO.ActivityDO" useGeneratedKeys="true"
            keyProperty="activityId">
        INSERT INTO activity
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="activityId != null">
                activity_id,
            </if>
            <if test="tagId != null">
                tag_id,
            </if>
            <if test="createDate != null">
                create_date,
            </if>
            <if test="creator != null">
                creator,
            </if>
            <if test="content != null">
                content,
            </if>
            <if test="theme != null">
                theme,
            </if>
            <if test="plannedNum != null">
                planned_num,
            </if>
            <if test="invalided != null">
                invalided,
            </if>
            <if test="hot != null">
                hot,
            </if>
            <if test="entryStartDate != null">
                entry_start_date,
            </if>
            <if test="entryEndDate != null">
                entry_end_date,
            </if>
            <if test="startDate != null">
                start_date,
            </if>
            <if test="endDate != null">
                end_date,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="activityId != null">
                #{activityId,jdbcType=VARCHAR},
            </if>
            <if test="tagId != null">
                #{tagId,jdbcType=INTEGER},
            </if>
            <if test="createDate != null">
                #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="creator != null">
                #{creator,jdbcType=VARCHAR},
            </if>
            <if test="content != null">
                #{content,jdbcType=VARCHAR},
            </if>
            <if test="theme != null">
                #{theme,jdbcType=VARCHAR},
            </if>
            <if test="plannedNum != null">
                #{plannedNum,jdbcType=INTEGER},
            </if>
            <if test="invalided != null">
                #{invalided,jdbcType=VARCHAR},
            </if>
            <if test="hot != null">
                #{hot,jdbcType=INTEGER},
            </if>
            <if test="entryStartDate != null">
                #{entryStartDate,jdbcType=TIMESTAMP},
            </if>
            <if test="entryEndDate != null">
                #{entryEndDate,jdbcType=TIMESTAMP},
            </if>
            <if test="startDate != null">
                #{startDate,jdbcType=TIMESTAMP},
            </if>
            <if test="endDate != null">
                #{endDate,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>

    <insert id="join">
        INSERT INTO
         entry_list
         (activity_id,user_id,create_date)
        VALUES
         (#{activityId,jdbcType=VARCHAR},
         #{userId,jdbcType=VARCHAR},
         #{createDate,jdbcType=VARCHAR})
    </insert>

    <select id="judgeJoin" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM entry_list
        WHERE user_id=#{userId,jdbcType=VARCHAR} AND activity_id=#{activityId,jdbcType=VARCHAR}
        limit 1
    </select>

    <select id="getById" resultMap="ActivityDOMap" parameterType="java.lang.String">
        SELECT * FROM activity WHERE activity_id=#{activityId,jdbcType=VARCHAR}
    </select>

    <select id="getActualNum" resultType="java.lang.Integer" parameterType="java.lang.String">
        SELECT COUNT(*) FROM activity
        LEFT JOIN entry_list ON activity.activity_id=entry_list.activity_id
        WHERE activity.activity_id=#{activityId,jdbcType=VARCHAR}
        GROUP BY activity.activity_id
    </select>

    <select id="getJoinActivityByDay" resultMap="ScheduleActivityVOMap" parameterType="java.lang.String">
        SELECT
               activity.activity_id,
               activity.start_date,
               activity.end_date,
               activity.theme,
               activity.planned_num,
               activity.tag_id,tag_name,
               activity.creator,user_name,
               activity.invalided,
               COUNT(entry_list.user_id) actual_num
        FROM activity
        LEFT JOIN tags ON (activity.tag_id=tags.tag_id)
        LEFT JOIN user ON (activity.creator=user.user_id)
        LEFT JOIN entry_list ON activity.activity_id=entry_list.activity_id
        WHERE  activity.activity_id IN(
          SELECT activity_id FROM entry_list WHERE user_id=#{userId,jdbcType=VARCHAR}
        )
        AND activity.start_date &gt;=#{date,jdbcType=VARCHAR}
        AND activity.end_date &lt;=#{date1,jdbcType=VARCHAR}
        GROUP BY activity.activity_id
    </select>

    <select id="getCreateActivityByDay" resultMap="ScheduleActivityVOMap" parameterType="java.lang.String">
        SELECT
               activity.activity_id,
               activity.start_date,
               activity.end_date,
               activity.theme,
               activity.planned_num,
               activity.tag_id,tag_name,
               activity.creator,user_name,
               activity.invalided,
               COUNT(entry_list.user_id) actual_num
        FROM activity
        LEFT JOIN tags ON (activity.tag_id=tags.tag_id)
        LEFT JOIN user ON (activity.creator=user.user_id)
        LEFT JOIN entry_list ON activity.activity_id=entry_list.activity_id
        WHERE  activity.creator=#{userId,jdbcType=VARCHAR}
        AND activity.start_date &gt;=#{date,jdbcType=VARCHAR}
        AND activity.end_date &lt;=#{date1,jdbcType=VARCHAR}
        GROUP BY activity.activity_id
    </select>

    <select id="judgeByDate" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM activity
        WHERE
        activity_id IN (SELECT activity_id FROM entry_list WHERE user_id=#{userId,jdbcType=VARCHAR})
        AND((start_date &gt;= #{startDate,jdbcType=VARCHAR} AND start_date &lt;= #{endDate,jdbcType=VARCHAR})
        OR(end_date &gt;= #{startDate,jdbcType=VARCHAR} AND end_date &lt;= #{endDate,jdbcType=VARCHAR}))
        limit 1
    </select>

    <select id="getUserEmails" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT email
        FROM user
        RIGHT JOIN entry_list ON(activity.activity_id=entry_list.activity_id)
        WHERE entry_list.activity_id=#{activityId,jdbcType=VARCHAR}
    </select>

    <select id="getCreator" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT creator FROM activiy WHERE activity_id=#{activityId,jdbcType=VARCHAR}
    </select>

    <update id="updateActivityInvalided" parameterType="java.lang.String">
        UPDATE activity SET invalided=#{state,jdbcType=VARCHAR}
        WHERE activity_id=#{activityId,jdbcType=VARCHAR}
    </update>
</mapper>